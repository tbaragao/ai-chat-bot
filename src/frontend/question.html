<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ask a Question</title>
    <!-- Tailwind (Play CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body { margin: 0; font-family: system-ui, sans-serif; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState } = React;

      // Escape HTML to prevent injection
      function escapeHtml(unsafe) {
        return unsafe
          .replaceAll(/&/g, "&amp;")
          .replaceAll(/</g, "&lt;")
          .replaceAll(/>/g, "&gt;")
          .replaceAll(/\"/g, "&quot;")
          .replaceAll(/'/g, "&#039;");
      }

      // Convert URLs in the text to clickable links. Assumes input is already HTML-escaped.
      function linkify(escaped) {
        const urlRegex = /(https?:\/\/[^\s)]+|www\.[^\s)]+)/g;
        return escaped.replace(urlRegex, (m) => {
          const href = m.startsWith("http") ? m : `http://${m}`;
          return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="text-blue-700 underline">${m}</a>`;
        });
      }

      // Normalize answer: trim wrapping quotes, unescape \n to real newlines, escape HTML, then linkify
      function formatAnswer(raw) {
        if (raw == null) return "";
        let s = String(raw).trim();
        // Trim matching surrounding quotes if present
        if ((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))) {
          s = s.slice(1, -1);
        }
        // Replace literal \n with actual newline characters
        s = s.replaceAll(/\\n/g, "\n");
        // Escape HTML before linkifying
        const escaped = escapeHtml(s);
        // Linkify URLs
        return linkify(escaped);
      }

      function App() {
        const [question, setQuestion] = useState("");
        const [isLoading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        const [answer, setAnswer] = useState("");

        async function onAsk(e) {
          e?.preventDefault();
          const q = question.trim();
          if (!q) return;
          setLoading(true);
          setError(null);
          setAnswer("");
          try {
            const url = `http://localhost:5108/ask?question=${encodeURIComponent(q)}`;
            const res = await fetch(url, { method: "GET" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            // Try to handle both JSON and plain text responses gracefully
            const contentType = res.headers.get("content-type") || "";
            if (contentType.includes("application/json")) {
              const data = await res.json();
              // Try common fields; fallback to stringifying
              const maybeAnswer =
                data?.answer ?? data?.result ?? data?.text ?? data?.message ?? "";
              setAnswer(formatAnswer(maybeAnswer || JSON.stringify(data)));
            } else {
              const text = await res.text();
              setAnswer(formatAnswer(text));
            }
          } catch (err) {
            console.error(err);
            setError(err.message || String(err));
          } finally {
            setLoading(false);
          }
        }

        return (
          <div className="min-h-screen bg-neutral-100">
            <header className="sticky top-0 bg-white border-b">
              <div className="mx-auto max-w-4xl px-6 py-4 flex items-center justify-between">
                <h1 className="text-xl font-semibold">❓ Ask a Question</h1>
              </div>
            </header>

            <main className="mx-auto max-w-4xl px-6 py-8">
              {/* Question form */}
              <form onSubmit={onAsk} className="flex items-stretch gap-2">
                <input
                  type="text"
                  placeholder="Type your question…"
                  className="flex-1 rounded-xl border border-neutral-300 px-4 py-3 text-[16px] focus:outline-none focus:border-neutral-400 bg-white"
                  value={question}
                  onChange={(e) => setQuestion(e.target.value)}
                />
                <button
                  type="submit"
                  disabled={isLoading || !question.trim()}
                  className="px-5 py-3 rounded-xl bg-blue-600 text-white disabled:bg-gray-300"
                >
                  {isLoading ? "Asking…" : "Ask"}
                </button>
              </form>

              {/* Status */}
              {error && (
                <div className="mt-4 text-sm text-rose-700 bg-rose-50 border border-rose-200 rounded-xl p-3">
                  Error: {error}
                </div>
              )}

              {/* Answer */}
              <section className="mt-8">
                {answer ? (
                  <div
                    className="bg-white border border-neutral-200 rounded-2xl p-5 whitespace-pre-wrap"
                    dangerouslySetInnerHTML={{ __html: answer }}
                  />
                ) : (
                  !isLoading && (
                    <p className="text-neutral-500">No answer yet. Ask something above.</p>
                  )
                )}
              </section>
            </main>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
